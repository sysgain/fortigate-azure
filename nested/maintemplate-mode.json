{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "adminUsername": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Username for fortigate Virtual Machine, make a note of the Username this will be used further"
            }
        },
        "adminPassword": {
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description": "Password for fortigate Virtual Machine,make a note of the Password this will be used further."
            }
        },
        "fortigateVMSize": {
            "type": "string",
            "defaultValue": "Standard_F1",
            "allowedValues": [
                "Standard_F1",
                "Standard_F16s",
                "Standard_F1s",
                "Standard_F2",
                "Standard_F2s",
                "Standard_F4",
                "Standard_F4s",
                "Standard_F8",
                "Standard_F8s"
            ],
            "metadata": {
                "description": "Fortigate Virtual Machine size(If you select any other size than the default one the cost will be more)"
            }
        },
        "clientID":{
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description":"Provide application ID of the service principle which crated earlier"
            }
        },
        "ClientSecret":{
            "type": "securestring",
            "defaultValue": "",
            "metadata": {
                "description":"Provide password of the service principle"
            }
        },
        "existingVnetName":{
            "type": "string",
            "defaultValue": "NA",
            "metadata": {
                "description":"If you choose ExistingspokeVnet as YES, then provide the name of the existing VNet.Otherwise keep the default value as it is"
            }
        },
        "fabricConnectorWorkloadAddressName":{
            "type": "string",
            "defaultValue": "testip",
            "metadata": {
                "description":"Provide the name of the fabric connector address"
            }
        },
        "fabricConnectorFirewallAddressName":{
            "type": "string",
            "defaultValue": "firewallip",
            "metadata": {
                "description":"Provide the name of teh FortiGate firewall address name"
            }
        },
        "hubFotigateVnetCIDR":{
            "type": "string",
            "defaultValue": "10.0.0.0/16",
            "metadata": {
                "description":"Provide the CIDR address for FortiGate vnet(Hub vnet)"
            }
        },
        "FortiGatePublicFacingSubnetCIDR":{
            "type": "string",
            "defaultValue": "10.0.0.0/24",
            "metadata": {
                "description":"Provide the CIDR address for FortiGate public facing subnet"
            }
        },
        "FortiGateInsideSubnetCIDR":{
            "type": "string",
            "defaultValue": "10.0.1.0/24",
            "metadata": {
                "description":"Provide the CIDR address for FortiGate internal(private facing) subnet"
            }
        },
        "FortiGatePublicFacingSubnetAddress":{
            "type": "string",
            "defaultValue": "10.0.0.4",
            "metadata": {
                "description":"Provide the static address of public facing subnet"
            }
        },
        "FortiGateInsideSubnetAddress":{
            "type": "string",
            "defaultValue": "10.0.1.4",
            "metadata": {
                "description":"Provide the statis address of internal(private facing) subnet"
            }
        }
    },
    "variables": {
        "apiVersions": {
            "deploymentApiVersion": "2016-02-01",
            "computeApiVersion": "2018-06-01",
            "networkApiVersion": "2017-09-01",
            "routtableApiVersion": "2015-06-15"
        },
        "networkSettings": {
            "location": "[variables('location')]",
            "networkApiVersion": "2016-03-30",
            "virtualNetworkName": "[concat('ForiGateVNET',variables('suffix'))]",
            "addressPrefix": "[parameters('hubFotigateVnetCIDR')]",
            "subnet1Name": "[concat('PublicFacingSubnet',variables('suffix'))]",
            "subnet1Prefix": "[parameters('FortiGatePublicFacingSubnetCIDR')]",
            "subnet2Name": "[concat('InternalSubnet',variables('suffix'))]",
            "subnet2Prefix": "[parameters('FortiGateInsideSubnetCIDR')]"
        },
        "fortigateFirewallSettings": {
            "location": "[variables('location')]",
            "fortiAvailName": "[concat('forti-avset',variables('suffix'))]",
            "FGPubFacingAddress": "[parameters('FortiGatePublicFacingSubnetAddress')]",
            "FGDMZAddress": "[parameters('FortiGateInsideSubnetAddress')]",
            "fortiPublicIPAddressName": "[concat('forti-pip',variables('suffix'))]",
            "publicIPAddressType": "Dynamic",
            "FortiGateName": "[concat('fortigateVM',variables('suffix'))]",
            "fortiNicName1": "[concat('forti-nic-1',variables('suffix'))]",
            "fortiNicName2": "[concat('forti-nic-2',variables('suffix'))]",
            "sku": "fortinet_fg-vm_payg",
            "version": "6.0.4",
            "product": "fortinet_fortigate-vm_v5",
            "publisher": "fortinet",
            "fortigateVMSize": "[parameters('fortigateVMSize')]",
            "storageAccountType": "Standard_LRS",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]",
            "fortiDnsLabelPrefix": "[concat('fortigate',variables('suffix'))]",
            "routeTable1Name": "[concat('fortigate', '-', variables('networkSettings').subnet1Name,'-routes')]",
            "routeTable2Name": "[concat('fortigate', '-', variables('networkSettings').subnet2Name,'-routes')]",
            "networkSecurityGroupName":"[concat('fortigatensg',variables('suffix'))]",
            "userData": "[concat('config system sdn-connector \n edit \"fg-azure-sdn\" \n set status enable \n set type azure \n set tenant-id \"',subscription().tenantId,'\" \n set subscription-id \"',subscription().subscriptionId,'\" \n set client-id \"',parameters('clientID'),'\" \n set client-secret \"',parameters('clientSecret'),'\" \n set resource-group \"', variables('rgName'),'\" \n set azure-region global \n set update-interval 60 \n end \n config firewall address \n edit \"',parameters('fabricConnectorWorkloadAddressName'),'\" \n set type dynamic \n set comment ','',' \n set visibility enable \n set associated-interface ','', '\n set color 0 \n set sdn azure \n set filter \"tag.displayName=web\" \n next \n end \n config firewall address \n edit \"',parameters('fabricConnectorFirewallAddressName'),'\" \n set type dynamic \n set comment ','',' \n set visibility enable \n set associated-interface ','', '\n set color 0 \n set sdn azure \n set filter \"tag.displayName=firewall\" \n next \n end \n config firewall policy \n edit 0 \n set name \"outbound\" \n set srcintf \"port2\" \n set dstintf \"port1\" \n set srcaddr \"all\" \n set dstaddr \"all\" \n set action accept \n set schedule \"always\" \n set service \"ALL\" \n set nat enable \n next \n end \n config firewall vip \n edit ssh-wl \n set extintf \"port1\" \n set extip \"',parameters('FortiGatePublicFacingSubnetAddress'),'\" \n set mappedip \"172.1.0.4\" \n set portforward enable \n set protocol tcp \n set extport 2222 \n set mappedport 22 \n end \n config firewall vip \n edit web-ip \n set extintf \"port1\" \n set extip \"',parameters('FortiGatePublicFacingSubnetAddress'),'\" \n set mappedip \"172.1.0.4\" \n set portforward enable \n set protocol tcp \n set extport 8888 \n set mappedport 8888 \n end \n config firewall policy \n edit 0 \n set name \"ssh-workload-policy\" \n set srcintf \"port1\" \n set dstintf \"port1\" \n set srcaddr \"all\" \n set dstaddr \"ssh-wl\" \n set action accept \n set schedule \"always\" \n set service \"ALL\" \n set logtraffic all \n set nat enable \n next \n end \n config firewall policy \n edit 0 \n set name \"web-policy\" \n set srcintf \"port1\" \n set dstintf \"port1\" \n set srcaddr \"all\" \n set dstaddr \"web-ip\" \n set action accept \n set schedule \"always\" \n set service \"ALL\" \n set logtraffic all \n set nat enable \n next \n end \n config firewall policy \n edit 0 \n set name \"internet-inbound-policy\" \n set srcintf \"port1\" \n set dstintf \"port1\" \n set srcaddr \"all\" \n set dstaddr \"all\" \n set action accept \n set schedule \"always\" \n set service \"ALL\" \n set logtraffic all \n set nat enable \n next \n end \n config firewall DoS-policy \n edit 0 \n set status disable \n set interface \"port1\" \n set srcaddr all \n set dstaddr \"testip\" \n set service ALL \n config anomaly \n edit \"tcp_syn_flood\" \n set status disable \n set log enable \n set action block \n set threshold 300 \n next \n end \n end \n config firewall policy \n edit 0 \n set name \"blocking-url-policy\" \n set srcintf \"port1\" \n set dstintf \"port1\" \n set srcaddr \"',parameters('fabricConnectorWorkloadAddressName'),'\" \n set dstaddr \"all\" \n set action accept \n set schedule \"always\" \n set service \"ALL\" \n set logtraffic securityevents \n set webfilter-profile \"default\" \n set profile-protocol-options \"default\" \n set ssl-ssh-profile \"certificate-inspection\" \n set nat enable \n set status disable \n next \n end')]"
         },       
        "location": "[resourceGroup().location]",
        "suffix": "[substring(uniqueString(resourceGroup().id), 0, 5)]",
        "rgName":"[resourceGroup().name]",
        "wlrouteTableName":"[concat('wlroute',variables('suffix'))]",
        "vnetId": "[resourceId(variables('rgName'), 'Microsoft.Network/virtualNetworks', variables('networkSettings').virtualNetworkName)]",
        "subnetRef": "[concat(variables('vnetId'), '/subnets/', variables('networkSettings').subnet1Name)]",
        "subnet1Ref": "[concat(variables('vnetId'), '/subnets/', variables('networkSettings').subnet2Name)]",
        "routeTable1Id": "[resourceId('Microsoft.Network/routeTables',variables('fortigateFirewallSettings').routeTable1Name)]",
        "routeTable2Id": "[resourceId('Microsoft.Network/routeTables',variables('fortigateFirewallSettings').routeTable2Name)]"
    },
    "resources": [
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[variables('fortigateFirewallSettings').routeTable1Name]",
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "properties": {
                "routes": [
                    {
                        "name": "[concat('to', '-', variables('networkSettings').subnet2Name)]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet2Prefix]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "[variables('fortigateFirewallSettings').FGPubFacingAddress]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[variables('fortigateFirewallSettings').routeTable2Name]",
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "properties": {
                "routes": [
                    {
                        "name": "[concat('to', '-', variables('networkSettings').subnet1Name)]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet1Prefix]",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "[variables('fortigateFirewallSettings').FGDMZAddress]"
                        }
                    },
                    {
                        "name": "to-Internet",
                        "properties": {
                            "AddressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIPAddress": "[variables('fortigateFirewallSettings').FGDMZAddress]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/routeTables",
            "name": "[variables('wlrouteTableName')]",
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "location": "[variables('networkSettings').location]",
            "properties": {
                "routes": [
                    {
                        "name": "[concat('to', '-', 'InternetDefaultRoute')]",
                        "properties": {
                            "addressPrefix": "0.0.0.0/0",
                            "nextHopType": "VirtualAppliance",
                            "nextHopIpAddress": "[variables('fortigateFirewallSettings').FGPubFacingAddress]"
                        }
                    }
                ]
            }
        },
        {
            "type": "Microsoft.Network/virtualNetworks",
            "name": "[variables('networkSettings').virtualNetworkName]",
            "apiVersion": "[variables('apiVersions').networkApiVersion]",
            "location": "[variables('networkSettings').location]",
            "dependsOn": [
                "[concat('Microsoft.Network/routeTables/', variables('fortigateFirewallSettings').routeTable1Name)]",
                "[concat('Microsoft.Network/routeTables/', variables('fortigateFirewallSettings').routeTable2Name)]"
            ],
            "properties": {
                "addressSpace": {
                    "addressPrefixes": [
                        "[variables('networkSettings').addressPrefix]"
                    ]
                },
                "subnets": [
                    {
                        "name": "[variables('networkSettings').subnet1Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet1Prefix]",
                            "routeTable": {
                                "id": "[variables('routeTable1Id')]"
                            }
                        }
                    },
                    {
                        "name": "[variables('networkSettings').subnet2Name]",
                        "properties": {
                            "addressPrefix": "[variables('networkSettings').subnet2Prefix]",
                            "routeTable": {
                                "id": "[variables('routeTable2Id')]"
                            }
                        }
                    }
                ]
            },
            "resources": [
                {
                    "apiVersion": "2016-06-01",
                    "type": "virtualNetworkPeerings",
                    "name": "vNet1tovNet2PeeringName",
                    "location": "[resourceGroup().location]",
                    "dependsOn": [
                        "[concat('Microsoft.Network/virtualNetworks/', variables('networkSettings').virtualNetworkName)]"
                    ],
                    "comments": "This is the peering from vNet 1 to vNet 2",
                    "properties": {
                        "allowVirtualNetworkAccess": "true",
                        "allowForwardedTraffic": "true",
                        "allowGatewayTransit": "true",
                        "useRemoteGateways": "false",
                        "remoteVirtualNetwork": {
                            "id": "[resourceId('Microsoft.Network/virtualNetworks',parameters('existingVNetName'))]"
                        }
                    }
                }
            ]
        },
        {
            "apiVersion": "2016-06-01",
            "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
            "name": "[concat(parameters('existingVNetName'),'/vNet2tovNet1PeeringName')]",
            "location": "[resourceGroup().location]",
            "dependsOn": [ 
                "[concat('Microsoft.Network/virtualNetworks/', variables('networkSettings').virtualNetworkName)]"
            ],
            "comments": "This is the peering from vNet 1 to vNet 2",
            "properties": {
                "allowVirtualNetworkAccess": "true",
                "allowForwardedTraffic": "true",
                "allowGatewayTransit": "true",
                "useRemoteGateways": "false",
                "remoteVirtualNetwork": {
                    "id": "[resourceId('Microsoft.Network/virtualNetworks',variables('networkSettings').virtualNetworkName)]"
                }
            }
        },
        {
            "type": "Microsoft.Compute/availabilitySets",
            "name": "[variables('fortigateFirewallSettings').fortiAvailName]",
            "apiVersion": "[variables('apiVersions').computeApiVersion]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "properties": {
                "platformFaultDomainCount": "2",
                "platformUpdateDomainCount": "2"
            },
            "sku": {
                "name": "Aligned"
            }
        },
        {
            "type": "Microsoft.Network/publicIPAddresses",
            "name": "[variables('fortigateFirewallSettings').fortiPublicIPAddressName]",
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "properties": {
                "publicIPAllocationMethod": "[variables('fortigateFirewallSettings').publicIPAddressType]",
                "dnsSettings": {
                    "domainNameLabel": "[variables('fortigateFirewallSettings').fortiDnsLabelPrefix]"
                }
            }
        },
        {
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[variables('fortigateFirewallSettings').fortiNicName1]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('fortigateFirewallSettings').fortiPublicIPAddressName)]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "[variables('fortigateFirewallSettings').FGPubFacingAddress]",
                            "subnet": {
                                "id": "[variables('subnetRef')]"
                            },
                            "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIpAddresses', variables('fortigateFirewallSettings').fortiPublicIPAddressName)]"
                            }
                        }
                    }
                ],
                "enableIPForwarding": true
            }
        },
        {
            "apiVersion": "[variables('apiVersions').routtableApiVersion]",
            "type": "Microsoft.Network/networkInterfaces",
            "name": "[variables('fortigateFirewallSettings').fortiNicName2]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "dependsOn": [
                "[concat('Microsoft.Network/publicIPAddresses/', variables('fortigateFirewallSettings').fortiPublicIPAddressName)]"
            ],
            "properties": {
                "ipConfigurations": [
                    {
                        "name": "ipconfig1",
                        "properties": {
                            "privateIPAllocationMethod": "Static",
                            "privateIPAddress": "[variables('fortigateFirewallSettings').FGDMZAddress]",
                            "subnet": {
                                "id": "[variables('subnet1Ref')]"
                            }
                        }
                    }
                ],
                "enableIPForwarding": true
            }
        },
        {
            "type": "Microsoft.Compute/virtualMachines",
            "name": "[variables('fortigateFirewallSettings').FortiGateName]",
            "apiVersion": "[variables('apiVersions').computeApiVersion]",
            "location": "[variables('fortigateFirewallSettings').location]",
            "tags": {
                "displayName": "firewall"
            },
            "plan": {
                "name": "[variables('fortigateFirewallSettings').sku]",
                "publisher": "[variables('fortigateFirewallSettings').publisher]",
                "product": "[variables('fortigateFirewallSettings').product]"
            },
            "dependsOn": [
                "[concat('Microsoft.Network/networkInterfaces/', variables('fortigateFirewallSettings').fortiNicName1)]",
                "[concat('Microsoft.Network/networkInterfaces/', variables('fortigateFirewallSettings').fortiNicName2)]",
                "[concat('Microsoft.Compute/availabilitySets/', variables('fortigateFirewallSettings').fortiAvailName)]"
            ],
            "properties": {
                "hardwareProfile": {
                    "vmSize": "[variables('fortigateFirewallSettings').fortigateVMSize]"
                },
                "availabilitySet": {
                    "id": "[resourceId('Microsoft.Compute/availabilitySets', variables('fortigateFirewallSettings').fortiAvailName)]"
                },
                "osProfile": {
                    "computerName": "[variables('fortigateFirewallSettings').FortiGateName]",
                    "adminUsername": "[variables('fortigateFirewallSettings').adminUsername]",
                    "adminPassword": "[variables('fortigateFirewallSettings').adminPassword]",
                    "customData": "[base64(variables('fortigateFirewallSettings').userData)]"
                },
                "storageProfile": {
                    "imageReference": {
                        "publisher": "[variables('fortigateFirewallSettings').publisher]",
                        "offer": "[variables('fortigateFirewallSettings').product]",
                        "sku": "[variables('fortigateFirewallSettings').sku]",
                        "version": "[variables('fortigateFirewallSettings').version]"
                    },
                    "osDisk": {
                        "createOption": "FromImage"
                       
                    },
                    "dataDisks": [
                        {
                            "diskSizeGB": "30",
                            "lun": 0,
                            "createOption": "Empty"
                        }
                    ]
                },
                "networkProfile": {
                    "networkInterfaces": [
                        {
                            "properties": {
                                "primary": true
                            },
                            "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('fortigateFirewallSettings').fortiNicName1)]"
                        },
                        {
                            "properties": {
                                "primary": false
                            },
                            "id": "[resourceId('Microsoft.Network/networkInterfaces',variables('fortigateFirewallSettings').fortiNicName2)]"
                        }
                    ]
                }
            }
        }
    ],
"outputs": {
    "fortigateFQDN": {
        "type": "string",
        "value": "[reference(variables('fortigateFirewallSettings').fortiPublicIPAddressName).dnsSettings.fqdn]"
    }
}
}
